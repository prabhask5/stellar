# Stellar Focus Extension Architecture

System design documentation for the Stellar Focus browser extension, covering the blocking engine, real-time synchronization, and failure recovery patterns.

---

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Stellar Focus Extension                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚   Service Worker    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   IndexedDB Cache   â”‚                       â”‚
â”‚  â”‚   (Background)      â”‚          â”‚   (Local Storage)   â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚             â”‚                                                                    â”‚
â”‚             â”‚ browser.webNavigation.onBeforeNavigate                            â”‚
â”‚             â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚   Blocking Engine   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   Redirect Handler  â”‚                       â”‚
â”‚  â”‚                     â”‚          â”‚                     â”‚                       â”‚
â”‚  â”‚  â€¢ Phase check      â”‚          â”‚  tabs.update()      â”‚                       â”‚
â”‚  â”‚  â€¢ Domain matching  â”‚          â”‚  â†’ blocked.html     â”‚                       â”‚
â”‚  â”‚  â€¢ Day scheduling   â”‚          â”‚                     â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              External Services                                   â”‚
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                              Supabase                                    â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ focus_sessions  â”‚  â”‚ block_lists     â”‚  â”‚ Realtime WebSocket      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚ (user sessions) â”‚  â”‚ (user lists)    â”‚  â”‚ (3 channels)            â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                                                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚    â”‚
â”‚  â”‚  â”‚blocked_websites â”‚  â”‚ Supabase Auth   â”‚                               â”‚    â”‚
â”‚  â”‚  â”‚(domain entries) â”‚  â”‚ (JWT tokens)    â”‚                               â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Design Principles

| Principle | Rationale |
|-----------|-----------|
| **Fail-Safe Offline** | When offline or uncertain, allow all navigation - never accidentally block legitimate browsing |
| **Online-First Blocking** | Only block when connectivity is verified and session state is confirmed from server |
| **Real-Time Primary** | WebSocket subscriptions provide instant state propagation (~100-500ms latency) |
| **Polling Backup** | 30-second interval catches any missed WebSocket events, ensuring eventual consistency |
| **Local Cache** | IndexedDB persists state across service worker restarts and brief offline periods |
| **Main Frame Only** | Block page navigations, not embedded iframes or resources |

---

## Blocking Decision Engine

The blocking engine evaluates every main-frame navigation through a fail-safe guard chain. Each guard defaults to **ALLOW** on uncertainty.

```
Navigation Event
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Main frame only?            â”‚â”€â”€ No â”€â”€â–¶ ALLOW (iframe)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ Yes
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Internal URL?               â”‚â”€â”€ Yes â”€â–¶ ALLOW (extension pages)
â”‚ (moz-extension://, about:)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ No
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Online?                     â”‚â”€â”€ No â”€â”€â–¶ ALLOW (fail-safe)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ Yes
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Active session?             â”‚â”€â”€ No â”€â”€â–¶ ALLOW
â”‚ (status === 'running')      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ Yes
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Focus phase?                â”‚â”€â”€ No â”€â”€â–¶ ALLOW (on break)
â”‚ (phase === 'focus')         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ Yes
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Domain in active block list?â”‚â”€â”€ No â”€â”€â–¶ ALLOW
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ Yes
              â–¼
         ğŸš« REDIRECT
         â†’ blocked.html
```

### Domain Matching

The domain resolution algorithm supports both exact matches and subdomain blocking:

| Hostname | Blocked Domain | Match? | Reason |
|----------|----------------|--------|--------|
| `youtube.com` | `youtube.com` | âœ“ | Exact match |
| `www.youtube.com` | `youtube.com` | âœ“ | Subdomain |
| `music.youtube.com` | `youtube.com` | âœ“ | Subdomain |
| `youtube.com` | `www.youtube.com` | âœ— | Parent doesn't match child |
| `notyoutube.com` | `youtube.com` | âœ— | Different domain |
| `youtube.com.evil.com` | `youtube.com` | âœ— | Not a subdomain |

### Day-Based Scheduling

Each block list has optional `active_days` scheduling:
- `null` = active every day
- `[1,2,3,4,5]` = active Monday through Friday only
- At navigation time, only lists active for the current day of week are evaluated

---

## Dual-Channel Synchronization

The extension uses a redundant synchronization strategy combining real-time WebSockets with polling backup.

### Real-Time Channel (Primary)

Three Supabase Realtime channels provide instant state updates:

| Channel | Table | Purpose |
|---------|-------|---------|
| Focus Sessions | `focus_sessions` | Session start/pause/stop events |
| Block Lists | `block_lists` | List enable/disable, day schedule changes |
| Blocked Websites | `blocked_websites` | Domain additions/removals |

**Latency**: ~100-500ms from action in Stellar app to blocking state change

### Polling Backup (Secondary)

Browser alarm triggers every 30 seconds:
1. Verify network connectivity to Supabase
2. Re-establish WebSocket subscriptions if just came online
3. Query for active focus session
4. Refresh block lists cache if session state changed

**Purpose**: Catches missed WebSocket events, handles subscription failures, ensures state eventually converges

### State Flow

```
Stellar App                    Supabase                Extension
    â”‚                             â”‚                        â”‚
    â”‚  Start focus session        â”‚                        â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                        â”‚
    â”‚                             â”‚                        â”‚
    â”‚                             â”‚  postgres_changes      â”‚
    â”‚                             â”‚  (WebSocket)           â”‚
    â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                             â”‚                        â”‚
    â”‚                             â”‚     Query fresh state  â”‚
    â”‚                             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                             â”‚                        â”‚
    â”‚                             â”‚     Return session     â”‚
    â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                             â”‚                        â”‚
    â”‚                             â”‚     Update cache       â”‚
    â”‚                             â”‚     Blocking active    â”‚
    â”‚                             â”‚                        â”‚
```

---

## Network State Machine

The extension tracks network connectivity and transitions between online/offline states gracefully.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Network State Transitions                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Online â†’ Offline:                                              â”‚
â”‚  â€¢ Blocking disabled (fail-safe)                                â”‚
â”‚  â€¢ WebSocket subscriptions become inactive                      â”‚
â”‚  â€¢ Cached state preserved for reference                         â”‚
â”‚                                                                 â”‚
â”‚  Offline â†’ Online:                                              â”‚
â”‚  â€¢ Active connectivity check to Supabase                        â”‚
â”‚  â€¢ Re-establish WebSocket subscriptions                         â”‚
â”‚  â€¢ Poll for fresh session state                                 â”‚
â”‚  â€¢ Refresh block lists cache                                    â”‚
â”‚  â€¢ Blocking re-enabled if session active                        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Connectivity Check**: HEAD request to Supabase URL (not just `navigator.onLine`) ensures the specific backend is reachable.

---

## Local Cache Layer

IndexedDB provides persistent local storage across service worker restarts.

### Cache Stores

| Store | Purpose | Key |
|-------|---------|-----|
| `blockLists` | User's block list configurations | `id` (UUID) |
| `blockedWebsites` | Domain entries for all lists | `id` (UUID) |
| `focusSessionCache` | Current session state | `'current'` (singleton) |

### Cache Lifecycle

**Populate**:
- On extension initialization
- After successful Supabase queries
- On real-time events

**Clear**:
- On user logout
- When Supabase returns empty results (user deleted data)
- On session expiration

**Preserve**:
- On query failures (keep known-good state)
- During offline periods

---

## Extension Storage Adapter

Browser extensions cannot use `localStorage` in the service worker context. A custom storage adapter bridges Supabase Auth to `browser.storage.local`:

```
Supabase Client                    Extension Storage
      â”‚                                   â”‚
      â”‚  persistSession: true             â”‚
      â”‚  storage: adapter  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚                                   â”‚
      â”‚  Token refresh                    â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ browser.storage.local.set()
      â”‚                                   â”‚
      â”‚  Get session                      â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ browser.storage.local.get()
      â”‚                                   â”‚
```

This enables:
- Session persistence across browser restarts
- Automatic token refresh in background
- Shared auth state between popup and service worker

---

## Failure Modes and Recovery

The extension is designed to fail safely and recover automatically.

### Failure Recovery Strategy

```
Any failure during blocking decision:
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ALLOW NAVIGATION    â”‚â—€â”€â”€ Never block on uncertainty
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Any failure during sync:
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KEEP EXISTING STATE â”‚â—€â”€â”€ Preserve known-good state
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RETRY NEXT POLL     â”‚â—€â”€â”€ 30-second auto-recovery
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Failure Categories

| Category | Behavior | Recovery |
|----------|----------|----------|
| **Network** (offline, timeout) | Allow navigation, use cached state | Poll re-checks every 30s |
| **Authentication** (expired, invalid) | Allow navigation, clear session | User re-authenticates |
| **Data** (corrupt cache, empty results) | Clear cache, refetch | Automatic on next poll |
| **Blocking** (navigation complete, invalid URL) | Page loads normally | By design |

---

## Communication Flow

Complete flow from user action in Stellar to blocking in the extension:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Stellar App     â”‚         â”‚      Supabase      â”‚         â”‚     Extension      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                              â”‚                              â”‚
          â”‚  Start focus session         â”‚                              â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                              â”‚
          â”‚                              â”‚                              â”‚
          â”‚                              â”‚  postgres_changes (INSERT)   â”‚
          â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
          â”‚                              â”‚                              â”‚
          â”‚                              â”‚         Query session        â”‚
          â”‚                              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚                              â”‚                              â”‚
          â”‚                              â”‚  Return focus_sessions row   â”‚
          â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
          â”‚                              â”‚                              â”‚
          â”‚                              â”‚      Update cache            â”‚
          â”‚                              â”‚      status: 'running'       â”‚
          â”‚                              â”‚      phase: 'focus'          â”‚
          â”‚                              â”‚                              â”‚
          â”‚                              â”‚  User navigates to           â”‚
          â”‚                              â”‚  youtube.com                 â”‚
          â”‚                              â”‚                              â”‚
          â”‚                              â”‚      Check: domain blocked?  â”‚
          â”‚                              â”‚      â†’ true                  â”‚
          â”‚                              â”‚                              â”‚
          â”‚                              â”‚      Redirect to             â”‚
          â”‚                              â”‚      blocked.html            â”‚
          â”‚                              â”‚                              â”‚
```
